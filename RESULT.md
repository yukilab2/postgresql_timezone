# PostgreSQLタイムゾーンテスト結果

## 環境設定

### postgres-utc (コンテナTZ: UTC)

| パラメータ                          | 値                             |
|:-------------------------------|:------------------------------|
| current_setting('timezone')    | UTC                           |
| current_setting('TimeZone')    | UTC                           |
| SHOW timezone                  | UTC                           |
| now()                          | 2025-03-30 13:24:16.266802+00 |
| CURRENT_TIMESTAMP              | 2025-03-30 13:24:16.266802+00 |
| CURRENT_TIMESTAMP::timestamp   | 2025-03-30 13:24:16.266802    |
| CURRENT_TIMESTAMP::timestamptz | 2025-03-30 13:24:16.266802+00 |

### postgres-jst (コンテナTZ: Asia/Tokyo)

| パラメータ                          | 値                             |
|:-------------------------------|:------------------------------|
| current_setting('timezone')    | Asia/Tokyo                    |
| current_setting('TimeZone')    | Asia/Tokyo                    |
| SHOW timezone                  | Asia/Tokyo                    |
| now()                          | 2025-03-30 22:24:17.017675+09 |
| CURRENT_TIMESTAMP              | 2025-03-30 22:24:17.017675+09 |
| CURRENT_TIMESTAMP::timestamp   | 2025-03-30 22:24:17.017675    |
| CURRENT_TIMESTAMP::timestamptz | 2025-03-30 22:24:17.017675+09 |

## タイムスタンプテスト結果

### postgres-utc (コンテナTZ: UTC)

#### セッションタイムゾーン: Asia/Tokyo

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: UTC

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: デフォルト

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

### postgres-jst (コンテナTZ: Asia/Tokyo)

#### セッションタイムゾーン: Asia/Tokyo

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: UTC

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: デフォルト

| 入力値の説明     | 入力 timestamp               | 入力 timestamptz             | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:-----------|:---------------------------|:---------------------------|:--------------------|:-----------------------|:---------------------|:---------------------|
| タイムゾーン情報なし | 2023-01-01 12:00:00        | 2023-01-01 12:00:00        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| UTC指定      | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 UTC    | 2023-01-01 12:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| JST指定      | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 +09:00 | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

## Pythonデータタイプテスト結果

### postgres-utc (コンテナTZ: UTC)

#### セッションタイムゾーン: Asia/Tokyo

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 21:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: UTC

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 03:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: デフォルト

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 03:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

### postgres-jst (コンテナTZ: Asia/Tokyo)

#### セッションタイムゾーン: Asia/Tokyo

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 21:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: UTC

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+00 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 03:00:00 | 2023-01-01 03:00:00+00 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

#### セッションタイムゾーン: デフォルト

| 入力値の説明                      | 入力 datetime               | tzinfo     | 出力 timestamp        | 出力 timestamptz         | timestamptz at UTC   | timestamptz at JST   |
|:----------------------------|:--------------------------|:-----------|:--------------------|:-----------------------|:---------------------|:---------------------|
| Python naive datetime       | 2023-01-01 12:00:00       | None       | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |
| Python aware datetime (UTC) | 2023-01-01 12:00:00+00:00 | UTC        | 2023-01-01 21:00:00 | 2023-01-01 21:00:00+09 | 2023-01-01 12:00:00  | 2023-01-01 21:00:00  |
| Python aware datetime (JST) | 2023-01-01 12:00:00+09:00 | Asia/Tokyo | 2023-01-01 12:00:00 | 2023-01-01 12:00:00+09 | 2023-01-01 03:00:00  | 2023-01-01 12:00:00  |

## セッション関数テスト結果

### postgres-utc (コンテナTZ: UTC)

#### セッションタイムゾーン: Asia/Tokyo

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 22:24:16.989774+09 | 2025-03-30 22:24:16.989774 |
| CURRENT_TIMESTAMP | 2025-03-30 22:24:16.989774+09 | 2025-03-30 22:24:16.989774 |

#### セッションタイムゾーン: UTC

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 13:24:16.962274+00 | 2025-03-30 13:24:16.962274 |
| CURRENT_TIMESTAMP | 2025-03-30 13:24:16.962274+00 | 2025-03-30 13:24:16.962274 |

#### セッションタイムゾーン: デフォルト

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 13:24:16.266802+00 | 2025-03-30 13:24:16.266802 |
| CURRENT_TIMESTAMP | 2025-03-30 13:24:16.266802+00 | 2025-03-30 13:24:16.266802 |

### postgres-jst (コンテナTZ: Asia/Tokyo)

#### セッションタイムゾーン: Asia/Tokyo

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 22:24:17.067253+09 | 2025-03-30 22:24:17.067253 |
| CURRENT_TIMESTAMP | 2025-03-30 22:24:17.067253+09 | 2025-03-30 22:24:17.067253 |

#### セッションタイムゾーン: UTC

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 13:24:17.044982+00 | 2025-03-30 13:24:17.044982 |
| CURRENT_TIMESTAMP | 2025-03-30 13:24:17.044982+00 | 2025-03-30 13:24:17.044982 |

#### セッションタイムゾーン: デフォルト

| 関数                | 値                             | timestampへの変換結果            |
|:------------------|:------------------------------|:---------------------------|
| now()             | 2025-03-30 22:24:17.017675+09 | 2025-03-30 22:24:17.017675 |
| CURRENT_TIMESTAMP | 2025-03-30 22:24:17.017675+09 | 2025-03-30 22:24:17.017675 |

## now()挿入テスト結果

### postgres-utc (コンテナTZ: UTC)

#### セッションタイムゾーン: Asia/Tokyo

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 22:24:17.009859 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 22:24:17.009859+09 |

#### セッションタイムゾーン: UTC

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 13:24:16.984599 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 13:24:16.984599+00 |

#### セッションタイムゾーン: デフォルト

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 13:24:16.953772 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 13:24:16.953772+00 |

### postgres-jst (コンテナTZ: Asia/Tokyo)

#### セッションタイムゾーン: Asia/Tokyo

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 22:24:17.093076 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 22:24:17.093076+09 |

#### セッションタイムゾーン: UTC

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 13:24:17.062887 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 13:24:17.062887+00 |

#### セッションタイムゾーン: デフォルト

| テスト内容         | 取得値 (timestamp)            | 取得値 (timestamptz)             |
|:--------------|:---------------------------|:------------------------------|
| now() to ts   | 2025-03-30 22:24:17.039247 | NULL                          |
| now() to tstz | NULL                       | 2025-03-30 22:24:17.039247+09 |

## 概要と結論

### timestamp型とtimestamptz型の違い

- **timestamp型**: タイムゾーン情報を保持しない。入力時にタイムゾーン情報があっても無視される。
- **timestamptz型**: タイムゾーン情報をUTCに変換して保存。出力時はセッションのタイムゾーンに変換される。

### コンテナタイムゾーンとセッションタイムゾーンの影響

- **コンテナタイムゾーン**: PostgreSQLのシステムタイムゾーンとなる。CURRENT_TIMESTAMPなどの関数に影響する。
- **セッションタイムゾーン**: timestamptz型の値をクライアントに返す際の表示タイムゾーン。

### Python datetime オブジェクトの挙動

- **naive datetime**: タイムゾーン情報を持たないDatetimeオブジェクトは、timestamptz型に挿入する際にセッションタイムゾーンで解釈される。
- **aware datetime**: タイムゾーン情報を持つDatetimeオブジェクトは、そのタイムゾーン情報に基づいてUTCに変換されてtimestamptz型に格納される。
- **timestamp型への挿入**: どちらのdatetimeオブジェクトも、timestamp型に挿入する場合はタイムゾーン情報が無視され、時刻部分のみが格納される。

### セッション関数 (now(), CURRENT_TIMESTAMP) の挙動

- これらの関数は常にtimestamptz型で現在時刻を返す。
- 戻り値はコンテナのシステムタイムゾーンに依存するが、表示はセッションタイムゾーンによって変わる。
- これらの関数結果をtimestamp型にキャスト（::timestamp）すると、タイムゾーン情報が失われる。

### now()の結果をカラムに挿入する場合の挙動

- **timestamp型に挿入**: now()の結果をtimestamp型カラムに挿入すると、タイムゾーン情報が失われ、セッションタイムゾーンでの時刻表現だけが格納される。
- **timestamptz型に挿入**: now()の結果をそのままtimestamptz型カラムに挿入すると、タイムゾーン情報が保持され、読み出し時にセッションタイムゾーンに応じた表示となる。

### 実用上の注意点

- タイムゾーンを正確に扱うためには、timestamptz型を使用することを推奨。
- アプリケーション間でタイムスタンプを受け渡す場合は、タイムゾーン情報を明示的に含める。
- セッションタイムゾーンはアプリケーションの要件に応じて適切に設定する。
- Pythonのnaive datetimeオブジェクトをtimestamptz型に挿入する際は注意が必要。可能な限りawareなdatetimeを使用するか、セッションタイムゾーンを明示的に設定する。
- now()やCURRENT_TIMESTAMPの結果をカラムに格納する場合、timestamp型とtimestamptz型の違いを理解し、適切な型を選択する。
