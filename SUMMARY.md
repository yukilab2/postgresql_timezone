# PostgreSQLのタイムゾーン動作まとめ

## テスト環境

2つの異なるタイムゾーン設定のPostgreSQLインスタンスでテストを実施しました：
- `postgres-utc`: コンテナタイムゾーンUTC (±00:00)
- `postgres-jst`: コンテナタイムゾーンAsia/Tokyo (+09:00)

各コンテナでは3種類のセッションタイムゾーン設定（デフォルト、UTC、Asia/Tokyo）をテストしました。

## テスト結果の重要な発見

### 1. timestamp型とtimestamptz型の基本的な違い

- **timestamp型**:
  - タイムゾーン情報を無視して入力された日時をそのまま保存
  - セッションタイムゾーンに関係なく常に同じ値が出力される
  - 例：「2023-01-01 12:00:00 UTC」を入力すると「2023-01-01 12:00:00」として保存（UTCは無視）

- **timestamptz型**:
  - 入力された日時をUTCに変換して内部保存
  - 出力時はセッションタイムゾーンに応じた表示に変換される
  - 例：「2023-01-01 12:00:00 UTC」を入力すると、JSTセッションでは「2023-01-01 21:00:00+09:00」と表示

### 2. タイムゾーン指定がない入力の扱い

- **timestamp型**: 単に日時のみを保存（「2023-01-01 12:00:00」）
- **timestamptz型**: セッションタイムゾーンの日時として解釈
  - JSTセッションでは「2023-01-01 12:00:00+09:00」（UTC: 03:00:00）として解釈
  - UTCセッションでは「2023-01-01 12:00:00+00:00」（UTC: 12:00:00）として解釈

### 3. セッションタイムゾーンの影響

- **timestamp型**: 影響なし
- **timestamptz型**: 同じデータでもセッションタイムゾーンによって表示が変わる
  - 例：UTCの「2023-01-01 12:00:00」は、JSTでは「2023-01-01 21:00:00+09:00」

### 4. コンテナタイムゾーンの影響

- コンテナタイムゾーンは主にデフォルトのセッションタイムゾーンに影響
- `now()`や`CURRENT_TIMESTAMP`などの日時関数の結果に影響
- Asia/Tokyoコンテナの`now()`は「2025-03-30 22:24:17.017675+09」
- UTCコンテナの`now()`は「2025-03-30 13:24:16.266802+00」

### 5. タイムゾーン変換と`AT TIME ZONE`演算子

- timestamptz型のデータを別のタイムゾーンの表現に変換可能
- `AT TIME ZONE 'UTC'`で統一的なUTC表現に変換できる
- 例：JSTの「2023-01-01 12:00:00+09:00」→ UTC変換後「2023-01-01 03:00:00」

### 6. PythonのDatetimeオブジェクトの挙動

- **naive datetime（タイムゾーン情報なし）**:
  - `timestamp`型に挿入: 時刻部分のみが格納される（「2023-01-01 12:00:00」）
  - `timestamptz`型に挿入: セッションタイムゾーンの時刻として解釈される
    - UTCセッションでは「2023-01-01 12:00:00+00:00」
    - JSTセッションでは「2023-01-01 12:00:00+09:00」

- **aware datetime（タイムゾーン情報あり）**:
  - `timestamp`型に挿入: タイムゾーン情報が無視され、時刻部分のみが格納される
    - 特にUTCとJSTの時差がある場合、変換による時刻変更が起きるため注意が必要
  - `timestamptz`型に挿入: タイムゾーン情報に基づいてUTCに変換され格納される
    - UTC aware datetimeを挿入すると、どのセッションでもUTC基準で変換される
    - JST aware datetimeを挿入すると、どのセッションでもJST基準で変換される

### 7. `now()`や`CURRENT_TIMESTAMP`の挙動

- 常に`timestamptz`型で現在時刻を返す
- セッションタイムゾーンに応じた表示形式となる
  - UTCセッションでは「2025-03-30 13:24:16.962274+00」
  - JSTセッションでは「2025-03-30 22:24:16.989774+09」
- `::timestamp`でキャストすると、タイムゾーン情報が失われる
  - UTCセッションでは「2025-03-30 13:24:16.962274」
  - JSTセッションでは「2025-03-30 22:24:16.989774」

### 8. `now()`の結果を異なるカラムに挿入する場合の挙動

- **`timestamp`型に挿入**: タイムゾーン情報が失われ、セッションタイムゾーンの表示形式の時刻部分のみが格納される
- **`timestamptz`型に挿入**: タイムゾーン情報が保持され、セッションタイムゾーンに応じた表示となる

## 実用上の推奨事項

1. **タイムゾーンを考慮すべき場合は`timestamptz`型を使用**
   - 異なるタイムゾーンのユーザーがアクセスするシステム
   - グローバルなデータ連携が必要な場合

2. **ローカル時間のみが重要な場合は`timestamp`型も検討**
   - 営業時間や特定地域だけでの使用
   - タイムゾーン変換が不要な場合

3. **セッションタイムゾーンの適切な設定**
   - アプリケーション起動時に明示的に設定する
   - ユーザーのロケールに合わせて動的に変更する

4. **タイムスタンプ値の入力時は明示的なタイムゾーン指定を推奨**
   - 「2023-01-01 12:00:00」より「2023-01-01 12:00:00+09:00」のように指定
   - システム間連携ではUTC表記（「2023-01-01 12:00:00Z」）を推奨

5. **Pythonのdatetimeオブジェクトを使用する場合**
   - `timestamptz`型を使用する場合は、可能な限りタイムゾーン情報を持つawareなdatetimeを使用
   - naiveなdatetimeを使用する場合は、セッションタイムゾーンを明示的に設定
   - `timestamp`型を使用する場合は、タイムゾーン情報が無視されることに注意

6. **`now()`や`CURRENT_TIMESTAMP`の結果を格納する場合**
   - タイムゾーン情報を保持したい場合は、`timestamptz`型カラムに格納
   - ローカル時間のみを記録したい場合は、`timestamp`型カラムに格納するか`::timestamp`でキャスト 